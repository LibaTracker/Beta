<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VR Tracker - Auto Sync Executor</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#9aa4b2;
      --accent:#6ee7b7;
      --danger:#ff6b6b;
      --success:#7ee787;
      --warning:#ffd36b;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;padding:20px;background:linear-gradient(180deg,#061121 0%, #071828 100%);color:#e6eef6}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px;flex-wrap:wrap}
    header h1{font-size:22px;margin:0;display:flex;align-items:center;gap:10px}
    .badge{background:var(--accent);color:#000;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700}
    .card{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);margin-bottom:16px}
    .card h2{font-size:16px;margin:0 0 12px 0;color:var(--accent);display:flex;align-items:center;gap:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"],input[type="number"]{background:var(--glass);border:1px solid rgba(255,255,255,0.05);color:#e6eef6;padding:9px;border-radius:8px;font-size:13px}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(110,231,183,0.1)}
    button{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));color:#e6eef6;border:1px solid rgba(255,255,255,0.06);padding:10px 16px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
    button:hover:not(:disabled){background:linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.04));transform:translateY(-1px)}
    button:disabled{opacity:.4;cursor:not-allowed}
    button.primary{background:linear-gradient(135deg, #6ee7b7, #34d399);color:#000;border:none}
    button.primary:hover:not(:disabled){background:linear-gradient(135deg, #7ef7c7, #44e3a9);box-shadow:0 4px 12px rgba(110,231,183,.3)}
    button.danger{background:linear-gradient(135deg, #ff6b6b, #ee5a5a);border:none}
    button.warning{background:linear-gradient(135deg, #ffd36b, #ffc043);color:#000;border:none}
    #logContainer{height:450px;overflow:auto;margin-top:12px;background:rgba(0,0,0,0.2);padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-family:'Courier New',monospace;font-size:12px}
    .log-line{padding:5px 0;border-bottom:1px dashed rgba(255,255,255,0.02);line-height:1.5}
    .log-info{color:var(--muted)}
    .log-success{color:var(--success)}
    .log-error{color:var(--danger)}
    .log-warning{color:var(--warning)}
    .status-box{padding:12px;border-radius:8px;margin-top:12px;border-left:4px solid;font-size:13px;font-weight:500}
    .status-running{background:rgba(110,231,183,0.08);border-left-color:var(--accent);color:var(--accent)}
    .status-success{background:rgba(126,231,135,0.08);border-left-color:var(--success);color:var(--success)}
    .status-error{background:rgba(255,107,107,0.08);border-left-color:var(--danger);color:var(--danger)}
    .status-info{background:rgba(154,164,178,0.08);border-left-color:var(--muted);color:var(--muted)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px}
    .stat{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
    .stat-value{font-size:26px;font-weight:700;color:var(--accent);margin-bottom:4px}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .tiny{font-size:11px;color:var(--muted)}
    .spinner{width:14px;height:14px;border-radius:50%;display:inline-block;vertical-align:middle;border:2px solid rgba(110,231,183,0.2);border-top-color:var(--accent);animation:spin 800ms linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .checkbox{display:flex;gap:10px;align-items:center}
    .checkbox input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:768px){.grid-2{grid-template-columns:1fr}}
    .info-panel{background:rgba(110,231,183,0.05);border:1px solid rgba(110,231,183,0.2);border-radius:8px;padding:12px;margin-top:12px;font-size:12px;color:var(--accent)}
    .info-panel strong{display:block;margin-bottom:6px}
    footer{margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.05);font-size:11px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        üéÆ VR Tracker
        <span class="badge">AUTO SYNC</span>
      </h1>
      <div style="margin-left:auto" class="tiny">Abra via <strong>http://localhost:8000</strong></div>
    </header>

    <!-- Configura√ß√£o -->
    <div class="card">
      <h2>‚öôÔ∏è Configura√ß√£o</h2>
      
      <div class="grid-2">
        <div>
          <label class="tiny" style="display:block;margin-bottom:6px">üìú Script Python</label>
          <input id="scriptPath" type="text" value="tracker_network_sync.py" style="width:100%" />
        </div>
        <div>
          <label class="tiny" style="display:block;margin-bottom:6px">‚è±Ô∏è Intervalo Daemon (segundos)</label>
          <input id="daemonInterval" type="number" value="300" min="30" style="width:100%" />
        </div>
      </div>

      <div class="info-panel">
        <strong>üí° Como Funciona:</strong>
        ‚Ä¢ O script detecta automaticamente o IP do seu PC<br>
        ‚Ä¢ Varre a rede local procurando o tracker<br>
        ‚Ä¢ Sincroniza a configura√ß√£o automaticamente<br>
        ‚Ä¢ Funciona em qualquer rede Wi-Fi!
      </div>

      <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="checkbox">
          <input id="autoRunOnce" type="checkbox" />
          <label for="autoRunOnce" class="tiny">üöÄ Executar ao carregar p√°gina</label>
        </div>
        <div class="checkbox">
          <input id="autoStartDaemon" type="checkbox" />
          <label for="autoStartDaemon" class="tiny">üîÑ Iniciar daemon ao carregar</label>
        </div>
      </div>
    </div>

    <!-- Controles -->
    <div class="card">
      <h2>üéØ Controles</h2>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
        <button class="primary" id="runOnceBtn" onclick="runOnce()">
          ‚ñ∂Ô∏è Executar Uma Vez
        </button>
        <button class="warning" id="runDaemonBtn" onclick="runDaemon()">
          üîÑ Iniciar Daemon
        </button>
        <button class="danger" id="stopDaemonBtn" onclick="stopDaemon()" style="display:none">
          ‚èπÔ∏è Parar Daemon
        </button>
      </div>

      <div id="statusDiv"></div>
    </div>

    <!-- Estat√≠sticas -->
    <div class="card">
      <h2>üìä Estat√≠sticas</h2>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="execCount">0</div>
          <div class="stat-label">Execu√ß√µes</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="successCount">0</div>
          <div class="stat-label">Sucessos</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="failCount">0</div>
          <div class="stat-label">Falhas</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="lastTime">--:--</div>
          <div class="stat-label">√öltima Exec</div>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div class="card">
      <h2>üìã Log de Execu√ß√£o</h2>
      
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <button onclick="clearLog()" style="flex:1">üßπ Limpar</button>
        <button onclick="copyLog()" style="flex:1">üìã Copiar</button>
        <button onclick="downloadLog()" style="flex:1">‚¨áÔ∏è Download</button>
      </div>

      <div id="logContainer"></div>
    </div>

    <footer>
      üíæ Prefer√™ncias salvas automaticamente no navegador<br>
      üîß Certifique-se de que <code>tracker_web_server.py</code> est√° rodando
    </footer>
  </div>

  <script>
    let logs = [];
    let execCount = 0;
    let successCount = 0;
    let failCount = 0;
    let daemonProcess = null;
    let isDaemonRunning = false;

    // Elementos
    const scriptPathInput = () => document.getElementById('scriptPath');
    const daemonIntervalInput = () => document.getElementById('daemonInterval');
    const autoRunOnceInput = () => document.getElementById('autoRunOnce');
    const autoStartDaemonInput = () => document.getElementById('autoStartDaemon');

    function addLog(message, type = 'info') {
        const logContainer = document.getElementById('logContainer');
        const logLine = document.createElement('div');
        logLine.className = `log-line log-${type}`;
        const time = new Date().toLocaleTimeString();
        logLine.textContent = `[${time}] ${message}`;
        logContainer.appendChild(logLine);
        logContainer.scrollTop = logContainer.scrollHeight;
        logs.push({ message, type, time: new Date() });
    }

    function clearLog() {
        document.getElementById('logContainer').innerHTML = '';
        logs = [];
        addLog('‚ú® Log limpo', 'success');
    }

    function copyLog() {
        const text = logs.map(l => `[${l.time.toLocaleTimeString()}] ${l.message}`).join('\n');
        navigator.clipboard.writeText(text).then(() => {
            addLog('üìã Copiado para clipboard!', 'success');
        }).catch(e => {
            addLog('‚ùå Falha ao copiar: ' + e.message, 'error');
        });
    }

    function downloadLog() {
        const text = logs.map(l => `[${l.time.toLocaleTimeString()}] ${l.message}`).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tracker_sync_${new Date().toISOString().slice(0,10)}.log`;
        a.click();
        window.URL.revokeObjectURL(url);
        addLog('‚¨áÔ∏è Log baixado!', 'success');
    }

    function setStatus(message, type) {
        const statusDiv = document.getElementById('statusDiv');
        const icons = {
            running: '‚è≥',
            success: '‚úÖ',
            error: '‚ùå',
            info: '‚ÑπÔ∏è'
        };
        statusDiv.innerHTML = `<div class="status-box status-${type}">${icons[type] || ''} ${message}</div>`;
    }

    function updateStats(success = false) {
        execCount++;
        if (success) {
            successCount++;
        } else {
            failCount++;
        }
        document.getElementById('execCount').textContent = execCount;
        document.getElementById('successCount').textContent = successCount;
        document.getElementById('failCount').textContent = failCount;
        document.getElementById('lastTime').textContent = new Date().toLocaleTimeString();
    }

    async function runOnce() {
        const btn = document.getElementById('runOnceBtn');
        const scriptPath = (scriptPathInput().value || 'tracker_network_sync.py').trim();

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="margin-right:8px;"></div>Executando...';

        addLog('üöÄ Iniciando auto-sync do tracker...', 'info');
        addLog(`üìú Script: ${scriptPath}`, 'info');

        // Verificar se est√° via file://
        if (location.protocol === 'file:') {
            addLog('‚ö†Ô∏è ERRO: Interface aberta via file://', 'error');
            addLog('   Abra via http://localhost:8000', 'warning');
            setStatus('Abra via servidor (http://localhost:8000)', 'error');
            btn.disabled = false;
            btn.innerHTML = '‚ñ∂Ô∏è Executar Uma Vez';
            updateStats(false);
            return;
        }

        try {
            setStatus('Executando scan de rede...', 'running');

            const response = await fetch('/api/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    script: scriptPath,
                    daemon: false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status} - ${response.statusText}`);
            }

            const result = await response.json();

            // Processar stdout
            if (result.stdout) {
                const lines = result.stdout.split('\n').filter(l => l.trim());
                lines.forEach(line => {
                    // Detectar tipo de log por emojis/conte√∫do
                    if (line.includes('‚úÖ') || line.includes('SUCCESS')) {
                        addLog(line, 'success');
                    } else if (line.includes('‚ùå') || line.includes('ERROR') || line.includes('ABORT')) {
                        addLog(line, 'error');
                    } else if (line.includes('‚ö†Ô∏è') || line.includes('WARNING')) {
                        addLog(line, 'warning');
                    } else if (!line.includes('===')) {
                        addLog(line, 'info');
                    }
                });
            }

            // Processar stderr
            if (result.stderr && result.stderr.trim()) {
                result.stderr.split('\n').filter(l => l.trim()).forEach(line => {
                    if (!line.includes('UserWarning')) { // Ignorar warnings comuns
                        addLog(line, 'error');
                    }
                });
            }

            const returncode = result.returncode ?? (result.success ? 0 : 1);

            if (returncode === 0) {
                addLog('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!', 'success');
                setStatus('Sincroniza√ß√£o bem-sucedida!', 'success');
                updateStats(true);
            } else {
                addLog(`‚ùå Script retornou c√≥digo: ${returncode}`, 'error');
                setStatus('Sincroniza√ß√£o falhou - verifique o log', 'error');
                updateStats(false);
            }

        } catch (error) {
            addLog(`‚ùå Erro: ${error.message}`, 'error');
            setStatus(`Erro: ${error.message}`, 'error');
            updateStats(false);
        }

        btn.disabled = false;
        btn.innerHTML = '‚ñ∂Ô∏è Executar Uma Vez';
    }

    function runDaemon() {
        const runBtn = document.getElementById('runOnceBtn');
        const daemonBtn = document.getElementById('runDaemonBtn');
        const stopBtn = document.getElementById('stopDaemonBtn');
        const interval = parseInt(daemonIntervalInput().value) || 300;

        if (!isDaemonRunning) {
            isDaemonRunning = true;
            runBtn.disabled = true;
            daemonBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            addLog(`üîÑ Modo daemon iniciado (intervalo: ${interval}s)`, 'success');
            setStatus(`Daemon ativo - sincronizando a cada ${interval}s`, 'running');

            // Executar primeira vez
            executeDaemonOnce();

            // Agendar pr√≥ximas
            daemonProcess = setInterval(() => {
                executeDaemonOnce();
            }, interval * 1000);
        }
    }

    async function executeDaemonOnce() {
        if (!isDaemonRunning) return;

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        addLog('üîÑ Sincroniza√ß√£o autom√°tica agendada...', 'info');

        try {
            const scriptPath = (scriptPathInput().value || 'tracker_network_sync.py').trim();

            const response = await fetch('/api/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ script: scriptPath })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();

            // Apenas linhas importantes no daemon
            if (result.stdout) {
                const lines = result.stdout.split('\n').filter(l => l.trim());
                const importantLines = lines.filter(l => 
                    l.includes('‚úÖ') || 
                    l.includes('‚ùå') || 
                    l.includes('IP do PC:') || 
                    l.includes('Tracker encontrado') ||
                    l.includes('Sincroniza√ß√£o')
                );
                
                importantLines.forEach(line => {
                    if (line.includes('‚úÖ')) addLog(`  ${line}`, 'success');
                    else if (line.includes('‚ùå')) addLog(`  ${line}`, 'error');
                    else addLog(`  ${line}`, 'info');
                });
            }

            const returncode = result.returncode ?? (result.success ? 0 : 1);
            updateStats(returncode === 0);

        } catch (error) {
            addLog(`  ‚ùå Erro: ${error.message}`, 'error');
            updateStats(false);
        }

        addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
    }

    function stopDaemon() {
        const runBtn = document.getElementById('runOnceBtn');
        const daemonBtn = document.getElementById('runDaemonBtn');
        const stopBtn = document.getElementById('stopDaemonBtn');

        if (daemonProcess) {
            clearInterval(daemonProcess);
            isDaemonRunning = false;

            runBtn.disabled = false;
            daemonBtn.style.display = 'block';
            stopBtn.style.display = 'none';

            addLog('‚èπÔ∏è Daemon parado', 'warning');
            setStatus('Daemon parado', 'info');
        }
    }

    // Salvar e carregar prefer√™ncias
    function savePrefs() {
        const prefs = {
            autoRunOnce: autoRunOnceInput().checked,
            autoStartDaemon: autoStartDaemonInput().checked,
            daemonInterval: daemonIntervalInput().value,
            scriptPath: scriptPathInput().value
        };
        try {
            localStorage.setItem('tracker_executor_prefs', JSON.stringify(prefs));
        } catch(e) {
            console.error('Erro ao salvar prefer√™ncias:', e);
        }
    }

    function loadPrefs() {
        try {
            const raw = localStorage.getItem('tracker_executor_prefs');
            if (!raw) return;
            const prefs = JSON.parse(raw);
            if (prefs.scriptPath) scriptPathInput().value = prefs.scriptPath;
            if (prefs.daemonInterval) daemonIntervalInput().value = prefs.daemonInterval;
            if (typeof prefs.autoRunOnce === 'boolean') autoRunOnceInput().checked = prefs.autoRunOnce;
            if (typeof prefs.autoStartDaemon === 'boolean') autoStartDaemonInput().checked = prefs.autoStartDaemon;
        } catch(e) {
            console.error('Erro ao carregar prefer√™ncias:', e);
        }
    }

    // Autostart
    async function handleAutostart() {
        if (location.protocol === 'file:') {
            addLog('‚ö†Ô∏è Interface via file:// - autostart desabilitado', 'warning');
            addLog('   Inicie tracker_web_server.py e acesse http://localhost:8000', 'info');
            setStatus('Abra via servidor (http://localhost:8000)', 'info');
            return;
        }

        if (autoRunOnceInput().checked) {
            addLog('‚öôÔ∏è Auto-run ao carregar: iniciando...', 'info');
            await runOnce();
        }

        if (autoStartDaemonInput().checked) {
            const interval = parseInt(daemonIntervalInput().value) || 300;
            addLog(`‚öôÔ∏è Auto-start daemon (${interval}s): iniciando...`, 'info');
            runDaemon();
        }
    }

    // Inicializa√ß√£o
    window.addEventListener('load', () => {
        loadPrefs();
        addLog('‚ú® Interface carregada', 'success');

        if (location.protocol === 'file:') {
            addLog('‚ö†Ô∏è Voc√™ abriu o arquivo localmente', 'warning');
            addLog('   Para funcionar, inicie: python tracker_web_server.py', 'info');
            addLog('   Depois acesse: http://localhost:8000/tracker_executor.html', 'info');
            setStatus('Inicie o servidor web', 'info');
        } else {
            addLog('üí° Pronto! Use os bot√µes acima para sincronizar', 'info');
            setStatus('Aguardando comando', 'info');
        }

        // Vincular eventos para salvar prefer√™ncias
        scriptPathInput().addEventListener('change', savePrefs);
        daemonIntervalInput().addEventListener('change', savePrefs);
        autoRunOnceInput().addEventListener('change', savePrefs);
        autoStartDaemonInput().addEventListener('change', savePrefs);

        // Executar autostart
        setTimeout(handleAutostart, 300);
    });
  </script>
</body>
</html>